

**<center><font size='3'>YOLOv5基于剪枝的”nas“测试报告</center>**

# 概要

​        前期通过剪枝算法实现模型压缩及缩短推理耗时，PC端测试尚不存在精度和速率问题，但在海思端出现严重的精度速率偏移。主要原因可能是以下导致：①剪枝后模型通道数为奇数，不便于海思进行量化加速；②反卷积层特征通道未对齐。

# 1 工程准备

## 1.1 测试算法框架及运行环境

算法框架选取[YOLOv5_v4.0](https://github.com/ultralytics/yolov5/tree/v4.0),主要依赖环境为服务器vision002

## 1.2 实现过程

依据模型4(见表1)进行向上补齐至8的倍数，额外对反卷积层进行剪裁，然后用yolov5s预训练模型进行重新训练。

- 在common.py中对block重定义增加参数自由度
- 给出新的网络结构定义

注：剪枝算法是控制卷积层的输出，卷积层的输入由前一层提供。由于反卷积层没有BN层，所以无法对输出进行定义。因此呈现出反卷积层输入输出通道数不一致的结果（之前转onnx时报错原因）。

## 1.3 数据集

训练集&验证集：[dmcode](http://172.16.102.80/#/image-display?storeId=37&type=1): 5736张； [qrcode](http://172.16.102.80/#/image-display?storeId=38&type=1): 5538张； [barcode](http://172.16.102.80/#/image-display?storeId=36&type=1): 8728张； [multicode(去除测试集)](http://172.16.102.80/#/image-display?storeId=46&type=1): 8128张； 共28130张   

测试集： 3112张及筛选的99张

# 2 测试结果及分析

本次训练epoch=2000

<a href="https://sm.ms/image/pHsFV2bQ76mBioW" target="_blank"><img src="https://whiskey-tuku.oss-cn-beijing.aliyuncs.com/img/%E9%A1%B9%E7%9B%AE%E6%96%87%E6%A1%A3&%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A/nas%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A-nas%E8%AE%AD%E7%BB%83%E6%8D%9F%E5%A4%B1.png" ></a>

## 2.1 各模型验证集测试结果对比

表1统计各模型的测试效果，conf=0.01，推理耗时默认图片640×640(batch_size=32)下对验证集（2631张）进行测试。

| 序号  |    模型    |           mAP@0.5            |     ▲      |   mmAP    | 模型大小  |             推理耗时             |  FLOPs   |
| :---: | :--------: | :--------------------------: | :--------: | :-------: | :-------: | :------------------------------: | :------: |
|   1   |  original  | <font color=red>0.965</font> |     0      |   0.850   |    15M    | **<font color=red>2.0ms</font>** |  17.5G   |
|   2   |  1/2通道   |            0.956             |   -0.027   |   0.837   |   3.9M    |              1.0ms               |   4.4G   |
|   3   | sl449_0.01 |            0.965             |   -0.017   |   0.838   |   2.48M   |              1.2ms               |   5.5G   |
|   4   | sl449_0.08 |            0.962             |   -0.020   |   0.825   |   1.62M   |              1.0ms               |   3.8G   |
| **5** | **”nas“**  |          **0.982**           | **+0.017** | **0.877** | **1.16M** |          **0.7-0.8ms**           | **3.2G** |

”nas“模型各项指标均为最优，其中精度相较于original提升1.7个点，推理耗时缩减65%。

## 2.2 ”NAS“模型在测试集3112张测试结果

表2  ”nas“模型在测试集3112张（conf=0.5）的测试结果

|  类型   | P（识别正确率） | FP(误检分布) | 1-R（漏检率） | AP50  |
| :-----: | :--------------: | :----------: | :----------: | :---: |
| dmcode  |       0.980       |     0.14     |      0.04       | 0.971 |
| qrcode  |       0.973       |     0.14     |      0.01       | 0.994 |
| barcode |       0.925       |     0.72     |     0.13     | 0.868 |

## 2.3 ”NAS“模型在测试集99张

表3为”nas“模型在测试集99张（conf=0.5）的测试结果

|  类型   |  TP  | FP(误检) | TP + FN | FN(漏检) | 漏检率 | AP50  |
| :-----: | :--: | :------: | :-----: | :------: | :----: | :---: |
| dmcode  |  47  |    3     |   47    |    0     |   0    | 0.999 |
| qrcode  |  72  |    1     |   76    |    4     |  0.05  | 0.965 |
| barcode | 140  |    7     |   152   |    12    |  0.08  | 0.96  |

## 2.4 结果分析

<center><img src="https://whiskey-tuku.oss-cn-beijing.aliyuncs.com/img/%E9%A1%B9%E7%9B%AE%E6%96%87%E6%A1%A3&%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A/nas%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A-nas%E6%9D%A1%E7%A0%81%E4%B8%8D%E5%AE%8C%E5%85%A8%E8%AF%86%E5%88%AB.jpg" alt="nas条码不完全识别" style="zoom:75%;" /></center>

​		虽然上述具有较优的测试结果，但是当导出图片结果发现存在大量的不完全识别，这可能是由于模型recall下降导致，而该工程的best模型保存主要依据mmAP指标，为了获得更好的recall和precision，添加F1指标保存策略。

# 3 best_F1 测试结果

表4 **不同指标保存策略下的模型**在640×640(batch_size=32)下对验证集（2631张）测试结果，conf=0.01。

| 序号 |  模型  | mAP@0.5 | mmAP  |   F1    | 模型大小 | 推理耗时  | FLOPs |
| :--: | :----: | :-----: | :---: | :-----: | :------: | :-------: | :---: |
|  1   | "nas"  |  0.982  | 0.877 | 0.9844  |  1.16M   | 0.7-0.8ms | 3.2G  |
|  2   | nas_F1 |  0.981  | 0.871 | 0.98475 |  1.15M   |   0.8ms   | 3.2G  |

<center><img src="https://whiskey-tuku.oss-cn-beijing.aliyuncs.com/img/%E9%A1%B9%E7%9B%AE%E6%96%87%E6%A1%A3&%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A/nas%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A-best_F1%E6%9D%A1%E7%A0%81%E8%AF%86%E5%88%AB.jpg" alt="nas条码完全识别" style="zoom:75%;" /></center>

如上图条码检测正常，并且其余样本未出现不完全识别现象。

表5 nas_F1模型在测试集99张（conf=0.5）的测试结果

|  类型   |  TP  | FP(误检) | TP + FN | FN(漏检) | 漏检率 | AP50  |
| :-----: | :--: | :------: | :-----: | :------: | :----: | :---: |
| dmcode  |  47  |    6     |   47    |    0     |   0    | 0.997 |
| qrcode  |  75  |    2     |   76    |    1     |  0.01  | 0.991 |
| barcode | 146  |    8     |   152   |    6     |  0.04  | 0.983 |

<center><img src="https://whiskey-tuku.oss-cn-beijing.aliyuncs.com/img/%E9%A1%B9%E7%9B%AE%E6%96%87%E6%A1%A3&%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A/nas%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A-nas_test99.png" alt="nas_f1_test99" style="zoom:100%;" /></center>

P.S. 图中参数 查准率P=TP/(TP+FP)  查全率R=TP/(TP+FN)，因此误检率为1-P，漏检率为1-R

---

# 4 综合分析

​		本次nas模型较剪枝后模型优越，其中精度相较于original甚至提升1.7个点，推理耗时缩减65%。同时提供新的模型保存策略，以获取更优P&R值的模型。后续可在nas基础上进行迭代剪枝。
